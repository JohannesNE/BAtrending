---
title: "Introduction to BAtrending"
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
---

```{r}
#| label: setup
library(BAtrending)
library(tidyverse)
library(patchwork)

theme_set(BAtrending:::theme_ba())
```

## Example data

When the BAtrending package includes a small sample dataset, `CO`. It contains paired measuemens of cardiac output (CO) with two methods: radionuclide ventriculography (rv) and impedance cardiography (ic). The dataset was published in [Bland JM, Altman DG. (1999) Measuring agreement in method comparison studies. Statistical Methods in Medical Research 8, 135-160](https://doi.org/10.1177/096228029900800204).

The `CO` dataset has 60 measurements in 12 subjects.

```{r}
ggplot(CO, aes(rv, ic)) +
  geom_point() + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  coord_equal()
```

## Creating a Bland Altman analysis

```{r}
compare_CO = compare_methods(CO, ref_col = "rv", alt_col = "ic", id_col = "sub")
compare_CO
```

Calculate confidence intervals for the estimates. 

```{r}
compare_CO_confint <- add_confint(compare_CO, nsim = 99) #TODO increase to 1999
compare_CO_confint
```

Plot the Bland Altman analysis

```{r}
ba_plot <- plot_BA(compare_CO_confint)
```

```{r}
# Model mean CO
mean_co_model <- lme4::lmer(mean ~ 1 + (1 | sub), data = compare_CO$data)
data_w_residuals <- mutate(compare_CO$data,
            resid_CO = residuals(mean_co_model),
            resid_diff = residuals(compare_CO$model)
)

residual_plot <- ggplot(data_w_residuals, aes(resid_CO, resid_diff, color = sub)) + 
  geom_point(show.legend = FALSE) 

ba_plot + residual_plot
```

```{r}
data2 <- CO |> 
  mutate(rep = row_number(), .by = sub) |> 
  pivot_longer(cols = c("rv", "ic"), names_to = "method", values_to = "CO")
```

```{r}
CO_change <- CO |> 
  group_by(sub) |> 
  reframe(
    d_rv = diff(rv),
    d_ic = diff(ic)
    ) |> 
  mutate(
    mean_change = (d_ic + d_rv) / 2,
    dif_change = d_ic - d_rv
    )

a <- ggplot(CO_change, aes(d_rv, d_ic, colour = sub)) +
  geom_point(show.legend = FALSE) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  coord_equal()

b <- ggplot(CO_change, aes(mean_change, dif_change, colour = sub)) + 
  BAtrending::add_BA_stats_geom_manual(bias = c(0,0,0),
                                       loa.lwr = -c(compare_CO_confint$BA_stats$change.loa, compare_CO_confint$BA_stats_ci$change.loa),
                                       loa.upr = c(compare_CO_confint$BA_stats$change.loa, compare_CO_confint$BA_stats_ci$change.loa)
  ) +
  geom_point(show.legend = FALSE)  
  #geom_hline(yintercept = BA_est_ci$change.loa[1]) +
  #geom_hline(yintercept = -BA_est_ci$change.loa[1])

a+b
```